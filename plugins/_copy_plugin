try:
    from ._plugin_base import PluginBase
except ImportError:
    from _plugin_base import PluginBase
import pyperclip
from tkinter import messagebox

class CopyPlugin(PluginBase):
    """复制插件：将选区内的文字复制到剪贴板"""
    
    # 插件信息
    name = "CopyPlugin"
    description = "将选区内的文字复制到剪贴板，快捷键: Ctrl+C"
    
    # 快捷键设置
    hotkey = "<Control-c>"
    
    def run(self, event=None):
        """执行复制操作"""
        # 获取上下文信息
        context = self.get_context()
        selected_area = context["selected_area"]
        text_segments = context["text_segments"]
        image_segments = context["image_segments"]
        
        if not selected_area:
            messagebox.showinfo("提示", "请先选择要复制的内容")
            return
        
        x0, y0, x1, y1 = selected_area
        selected_text = []
        selected_images = 0
        
        # 匹配选中区域内的文字
        for seg in text_segments:
            s_x0, s_y0, s_x1, s_y1, text = seg
            # 判断文本片段是否与选中区域重叠
            if not (s_x1 < x0 or s_x0 > x1 or s_y1 < y0 or s_y0 > y1):
                selected_text.append(text)
        
        # 匹配选中区域内的图片
        for img in image_segments:
            i_x0, i_y0, i_x1, i_y1, _ = img
            if not (i_x1 < x0 or i_x0 > x1 or i_y1 < y0 or i_y0 > y1):
                selected_images += 1
        
        # 处理复制逻辑
        if selected_text:
            pyperclip.copy(" ".join(selected_text))
            messagebox.showinfo("提示", "已复制选中文字到剪贴板")
        elif selected_images > 0:
            messagebox.showinfo("提示", f"选中了 {selected_images} 张图片（暂不支持复制图片）")
        else:
            messagebox.showinfo("提示", "未选中任何内容")